<script>
const SearchServiceimagePath="https://cdn.jsdelivr.net/gh/volantis-x/cdn-volantis@master/img/logo/";
const ROOT =  ("<%- config.root %>" || "/").endsWith('/') ? ("<%- config.root %>" || "/") : ("<%- config.root %>/" || "/" );

function loadSearchScript(){
  return  volantis.import.jQuery().then(()=>{
    return new Promise((resolve) => {
      // see: layout/_partial/scripts/cdnCtrl.ejs
      volantis.js('<%- theme.cdn.map.js.search %>').then(()=>{ // 此处依赖JQ
        setSearchService()
        resolve()
      })
    })
  })
}

function loadSearchService(){
  loadSearchScript()
  document.querySelectorAll('.input.u-search-input').forEach((e)=>{
    e.removeEventListener('focus',loadSearchService,false)
  })
}

// 打开并搜索 字符串 s
function OpenSearch(s) {
  loadSearchScript().then(()=>{
    volantis.customSearch.queryText=s
    volantis.customSearch.search()
  })
}

// 访问含有 ?s=xxx  的链接时打开搜索
if (window.location.search&&/^\?s=/g.test(window.location.search)) {
  let queryText = decodeURI(window.location.search).replace(/\ /g, '-').replace(/^\?s=/g, '');
  OpenSearch(queryText)
}

// 搜索输入框获取焦点时加载搜索
document.querySelectorAll('.input.u-search-input').forEach((e)=>{
  e.addEventListener('focus',loadSearchService,false)
})

function listenSearch(){
  <% if(theme.search.service === 'baidu') { %>
    const BAIDU_API_ID = "<%- theme.search.baidu.apiId %>";
    volantis.customSearch = new BaiduSearch({
      apiId: BAIDU_API_ID,
      imagePath: SearchServiceimagePath
    });
  <%} else if(theme.search.service === 'algolia') { %>
    const ALGOLIA_API_KEY = "<%- theme.search.algolia.apiKey %>";
    const ALGOLIA_APP_ID = "<%- theme.search.algolia.applicationID %>";
    const ALGOLIA_INDEX_NAME = "<%- theme.search.algolia.indexName %>";
    volantis.customSearch = new AlgoliaSearch({
      apiKey: ALGOLIA_API_KEY,
      appId: ALGOLIA_APP_ID,
      indexName: ALGOLIA_INDEX_NAME,
      imagePath: SearchServiceimagePath
    });
  <%} else if(theme.search.service === 'azure') { %>
    const AZURE_QUERY_KEY = "<%- theme.search.azure.queryKey %>";
    const AZURE_INDEX_NAME = "<%- theme.search.azure.indexName %>";
    const AZURE_SERVICE_NAME = "<%- theme.search.azure.serviceName %>";
    volantis.customSearch = new AzureSearch({
      serviceName: AZURE_SERVICE_NAME,
      indexName: AZURE_INDEX_NAME,
      queryKey: AZURE_QUERY_KEY,
      imagePath: SearchServiceimagePath
    });
  <%} else if(theme.search.service === 'google') { %>
    const GOOGLE_CUSTOM_SEARCH_API_KEY = "<%- theme.search.google.apiKey %>";
    const GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "<%- theme.search.google.engineId %>";
    volantis.customSearch = new Googlevolantis.customSearch({
      apiKey: GOOGLE_CUSTOM_SEARCH_API_KEY,
      engineId: GOOGLE_CUSTOM_SEARCH_ENGINE_ID,
      imagePath: SearchServiceimagePath
    });
  <%} else {%>
    volantis.customSearch = new HexoSearch({
      imagePath: SearchServiceimagePath
    });
  <%}%>
}
function setSearchService() {
	listenSearch();
	<% if(theme.cover.layout_scheme=='search'){%>
		document.addEventListener("pjax:success", listenSearch);
	<% } %>
}
</script>
